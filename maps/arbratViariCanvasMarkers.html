<!DOCTYPE html>
<html lang="en">

<head>
    <title>Heatmap of Road Trees in Barcelona</title>
    <meta charset="UTF-8">
    <meta name="language" content="en">

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- rbush for spatial indexing -->
    <script src="https://cdn.jsdelivr.net/npm/rbush@2.0.2/rbush.min.js"></script>

    <!-- Leaflet.Canvas-Markers Plugin -->
    <script src="./canvasMarker.js"></script>

    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
        }

        #map {
            position: relative;
            width: 100%;
            height: 100%; /* Adjusted to make room for slider */
        }

    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        // Initialize the map
        const map = L.map('map').setView([41.3851, 2.1734], 13);

        // Add a tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            maxZoom: 19,
            preferCanvas: true
        }).addTo(map);

        // Initialize CanvasIconLayer after the map
        window.layerFactory(L); // Call the factory to extend Leaflet with canvas markers
        var ciLayer = L.canvasIconLayer({}).addTo(map);

        // Click and hover listeners
        ciLayer.addOnClickListener(function (e, data) {
            console.log(data);
        });
        ciLayer.addOnHoverListener(function (e, data) {
            console.log(data[0].data._leaflet_id);
        });

        // Define the icon for the markers
        var icon = L.icon({
            iconUrl: '../images/marker.png',
            iconSize: [20, 18],
            iconAnchor: [10, 9]
        });

        // Fetch and load tree data
        fetch('./arbratViari/extracted_2024_1T_OD_Arbrat_Viari_BCN.json')
            .then(response => response.json())
            .then(data => {
                var markers = [];  // Initialize an empty array to store the markers

                data.forEach(item => {
                    // Ensure valid latitude and longitude
                    if (!isNaN(item.latitude) && !isNaN(item.longitude)) {
                        // Create a marker for each item in the dataset using the parsed latitude and longitude
                        var marker = L.marker([parseFloat(item.latitude), parseFloat(item.longitude)], { icon: icon })
                            .bindPopup(`Tree Info: ${item.common_name || 'Unknown'}<br>Height: ${item.height || 'Unknown'}`);

                        // Push the created marker into the markers array
                        markers.push(marker);
                    }
                });

                // Add all markers to the ciLayer at once for better performance
                ciLayer.addLayers(markers);
            })
            .catch(error => {
                console.error('Error fetching tree data:', error);
                alert('Failed to load tree data.');
            });

        // Fetch and load GeoJSON data for Barcelona districts
        fetch('./barcelonaDistrictes.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: {
                        color: "#000",
                        weight: 1,
                        opacity: 0.4,
                        fillOpacity: 0
                    }
                }).addTo(map);
            });
    </script>
</body>

</html>
