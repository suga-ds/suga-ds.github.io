<!DOCTYPE html>
<html lang="en">

<head>
    <title>Leaflet H3 Grid Visualization</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            position: relative;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
        }

        .legend {
            background: white;
            padding: 15px;
            line-height: 1.5;
            border: 2px solid #999;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/h3-js@3.7.2/dist/h3-js.umd.js"></script>
    <script>
        // 1. Create a Leaflet map centered on Barcelona
        var map = L.map('map').setView([41.3851, 2.1734], 12);  // Barcelona coordinates

        // 2. Add a basic OpenStreetMap tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 3. Load the JSON file using a fetch request
        fetch('habitatgesTurísticsBarcelona.json')
            .then(response => response.json())
            .then(jsonData => {
                // 4. Define the H3 resolution
                var resolution = 10;

                // 5. Convert each point to an H3 index and count occurrences
                var h3Counts = {};  // Dictionary to store point counts in each H3 cell

                jsonData.forEach(function(point) {
                    var h3Index = h3.geoToH3(point.latitude, point.longitude, resolution);
                    h3Counts[h3Index] = (h3Counts[h3Index] || 0) + 1;
                });

                // 6. Create GeoJSON features for each H3 cell
                var hexFeatures = Object.keys(h3Counts).map(function(h3Index) {
                    var h3Boundary = h3.h3ToGeoBoundary(h3Index, true);
                    return {
                        "type": "Feature",
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[...h3Boundary, h3Boundary[0]]]  // Close the polygon
                        },
                        "properties": {
                            "count": h3Counts[h3Index]  // Add point count as a property
                        }
                    };
                });

                // 7. Create a GeoJSON layer and style based on the point count
                L.geoJSON(hexFeatures, {
                    style: function (feature) {
                        var count = feature.properties.count;
                        var color = count > 10 ? '#800026' : 
                                    count > 5  ? '#BD0026' : 
                                    count > 2  ? '#E31A1C' : 
                                    count > 1  ? '#FC4E2A' : '#FFEDA0';
                        
                        return { color: color, weight: 1, fillOpacity: 0.6, fillColor: color };
                    },
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup("Points: " + feature.properties.count);
                    }
                }).addTo(map);
            });

        // Load district boundaries
        fetch('../barcelonaDistrictes.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: {
                        color: "#000",
                        weight: 1,
                        opacity: 0.4,
                        fillOpacity: 0
                    }
                }).addTo(map);
            });

        // 8. Create a legend control and add it to the map
        var legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            var grades = [0, 2, 5, 10];
            var colors = [
                '#FFEDA0',
                '#FC4E2A',
                '#E31A1C',
                '#BD0026',
                '#800026'
            ];

            // Loop through density intervals and generate a label with a colored square for each interval
            div.innerHTML += "<h4>Point Count</h4>";
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + colors[i] + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }

            return div;
        };

        legend.addTo(map);
    </script>
</body>
</html>
